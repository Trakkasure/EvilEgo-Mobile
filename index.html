<!DOCTYPE html>
<html>
    <head>
        <title></title>
	<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
        <link rel="stylesheet" href="css/core.css" />

        <!-- iPad/iPhone specific css below, add after your main css >
        <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
        <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
        -->
        <!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www directory and include it here -->
        <script type="text/javascript" charset="utf-8" src="phonegap-1.2.0.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery.mobile-1.0.min.js"></script>

        <script src="js/underscore-min.js"></script>
        <script src="js/backbone-min.js"></script>
        <script src="js/json2.js"></script>

        <script type="text/javascript">
            
            // If you want to prevent dragging, uncomment this section
            function preventBehavior(e) {
                e.preventDefault(); 
            }
            //document.addEventListener("touchmove", preventBehavior, false);
            /* */

            /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
            see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
            for more details -jm */
            /*
            function handleOpenURL(url)
            {
                    // TODO: do something with the url passed in.
            }
            */

            var _ready = $.Deferred()
            document.addEventListener("deviceready", _ready.resolve, false);
            $(function() {
                console.log('On body load')
                if (!PhoneGap.available) {
                    console.log('Running outside of mobile device')
                    setTimeout('_ready.resolve()',1000) // delay the resolve so phonegap can call it first if it is loaded
                }
            })

            /* When this function is called, PhoneGap has been initialized and is ready to roll */
            /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
            see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
            for more details -jm */

            _ready.done(function () {
                        // do your thing!
                        //if (navigator.notification) navigator.notification.alert("PhoneGap is working")

                // First thing to do is to get the user's stored mobile login token, if there is one. otherwise we will ask them ot log in.
                // var db = window.openDatabase("EvilEgo", "1.0", "EvilEgo Local Storage", 200000);

                if (window.localStorage) {
                    var lastLogin = window.localStorage.getItem('lastLogin')
                    if (lastLogin === 'undefined') lastLogin = null
                    var lastLoginUser = null

                    if (lastLogin) {
                        EvilEgo.currentUser = lastLogin
                        EvilEgo.loggedInUser = JSON.parse(window.localStorage.getItem(lastLogin))
                    } else {
                        EvilEgo.currentUser = ''
                    }
                }

                sameOrigin = location.origin
                EvilEgo.dataHost = (window.device&&window.device.phonegap)?'http://mobile.evilego.com:4000':sameOrigin
                
                if (console.log == logCatcher) console.log=_oldlog
                _(logs).each(function(t){console.log.apply(console,t)})

                loaded.resolve()

                //tx.executeSql("SELECT value FROM settings where name='lastLogin'", [], function(tx, results) {
                    // this will be empty since no rows were inserted.
                    /* This is here to know what to look for later when doing more DB manipulation 
                    console.log("Login ID = " + results.insertId);
                    // this will be 0 since it is a select statement
                    console.log("Rows Affected = " + results.rowAffected);
                    // the number of rows returned by the select statement
                    console.log("Insert ID = " + results.rows.length);
                    /* */
                /*
                        if (results.rows.length>=0) {
                            tx.executeSql("SELECT * FROM user where login=%d", [results[0].value], function(tx, results) {
                            }, function(err) {
                            })
                        }
                }, function (err) {
                        alert("Error processing SQL: "+err.code);
                })
                /* */

            })
        </script>
    </head>
    <body style="-webkit-user-select: none; -webkit-touch-callout: none;"> 
        <!-- LOGIN PAGE -->
        <div data-role="page" id="login">
            <div data-role="header" data-position="fixed"> 
                <h1>EvilEgo</h1> 
            </div> 
            <div id="loginContainer"></div>
        </div>
        
        <!-- NEWSFEED PAGE -->
        <div data-role="page" id="newsfeed" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <h1 style="margin-top: 5px; margin-bottom: 0"><img src="http://www.evilego.com/images/core/logos/logo_horizontal_sm.png" alt="EvilEgo.com"></h1> 
            </div> 
            <div id="newsfeedContainer"></div>
            <div data-role="footer" class="ui-bar footer" data-position="fixed"> 
                <a href="#newPost" data-role="button" data-icon="plus" id="newPost">Add Post</a>
            </div> 
        </div>
        
        <!-- NEW POST PAGE -->
        <div data-role="page" id="newPost" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <h1 style="margin-top: 5px; margin-bottom: 0"><img src="http://www.evilego.com/images/core/logos/logo_horizontal_sm.png" alt="EvilEgo.com"></h1> 
            </div> 
        </div>
    </body>

    <script type="text/javascript">
        // this sets up the Backbone model to use Mongo's _id
        // put this somewhere in your client Backbone application
        // when it fetches, the MongoDB ID is effectively mapped to the Backbone model correctly
        // https://github.com/documentcloud/backbone/issues/37
        var oldSet = Backbone.Model.prototype.set;
        _.extend(Backbone.Model.prototype, {
            set: function(attrs, options) {
                if ('_id' in attrs) this.id = attrs._id
                oldSet.apply(this, [attrs, options])
                return this
            }
        })
        EvilEgo = {
            currentUser : false
          , models      : {}
          , collections : {}
          , flags       : {}
          , templates   : {}
        }
        function getTemplate(file,addId) {
            console.log('getTemplate: '+file)
            var d = $.Deferred()
            if (EvilEgo.templates[file]) {
                if (addId && $('#'+addId).length==0)
                  $('head').append('<script id="'+addId+'" type="text/x-jquery-tmpl">').append(EvilEgo.templates[file])
                  d.resolveWith(EvilEgo.templates[file])
            }
            if (!addId) 
                addId='script-'+$('script').length
            console.log('getting Template: '+file)
            $.get(file,function(){},'text').done(function(data){
                console.log('Loaded file: '+file)
                EvilEgo.templates[file] = data
                $('head').append('<script id="'+addId+'" type="text/x-jquery-tmpl">')
                $('script#'+addId).html(data)
                d.resolveWith(data)
            }).fail(function(err) {
                console.log('Error occured downloading template file "%s":%s',file)
                console.log(err)
                d.rejectWith(err||'An error occurred while loading template:' +file)
            })
            return d
        }


// Handle iOS not being ready to log console messages.
        logs = []
        function logCatcher() {
            logs.push(arguments)
        }
        _oldlog = console.log
        console.log=logCatcher

    </script>
    <script src="js/jquery.tmpl.min.js"></script>
    <script src="model/user.js"></script>
    <script src="view/user.js"></script>
    <script src="model/player.js"></script>
    <script src="view/player.js"></script>
    <script src="model/post.js"></script>
    <script src="view/post.js"></script>
    <script type="text/javascript">
        //Backbone.history.start()
        loaded = $.Deferred()
        $.when(lfd,loaded).done(function(data) {
            console.log('Load complete. Display login form')
            Login = new LoginView ({model: new UserModel({login:EvilEgo.currentUser||''})})
        }).fail(function(data) {
            console.log('Error load.')
            console.log(data)
        })
    </script>


</html>
