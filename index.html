<!DOCTYPE html>
<html>
    <head>
        <title></title>
	<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
        <link rel="stylesheet" href="css/core.css" />
            <!-- iPad/iPhone specific css below, add after your main css >
        <link rel="stylesheet" type="text/css" href="http://assets.transloadit.com/css/transloadit2.css" />

        <link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
        <link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
         -->

            <script src="js/jquery.min.js"></script>
        <script src="js/jquery.mobile-1.0.min.js"></script>
        <script type="text/javascript" src="js/underscore-min.js"></script>
        <script type="text/javascript" src="js/json2.js"></script>
        <script type="text/javascript" charset="utf-8" src="phonegap-1.3.0.js"></script>
        <script type="text/javascript" charset="utf-8" src="../phonegap-1.2.0.js"></script>
        <script type="text/javascript" charset="utf-8" src="js/notificationex.js"></script>
        <script type="text/javascript" src="js/backbone-min.js"></script>
        <script type="text/javascript" src="js/notifier.js"></script>

        <script type="text/javascript">
            Hoptoad.setKey('fb1f4b34303ea8084ce3a69743b31fc9')
            Hoptoad.setEnvironment('mobile')
            Hoptoad.setErrorDefaults({
                url: "http://evilego.com/mobile"
              , component: "mobile"
              , action: "show"
            })
            var errorTimeout = []
            window.onorientationchange = function() {
                if (errorTimeout.length) 
                    while(errorTimeout.length) clearTimeout(errorTimeout.pop())
            }
            // Debounce to limit the amount of reporting that occurs.
            window.onerror = _.debounce(function(message,file,line) {
                var args = arguments
                // These happen all the time from the phonegap system. Can't prevent this.
                console.log("Exception: "+message)
                if (message === "TypeError: 'undefined' is not a function") return false
                errorTimeout.push(setTimeout(function() {
                if (navigator.notification) 
                   navigator.notification.alert("An unexpected error occured.\n"+message+"\n"+file+"\n"+line,function(){location.reload()})
                else alert('An unexpected error occured.')
                console.log("Exception argument count:"+args.length)
                _(args).each(function(item) {
                    console.log(JSON.stringify(item))
                })
                /*
                Hoptoad.notify({
                    message : message
                  , stack   : '()@' + file + ':' + line
                }).done(function() {
                    console.log('Error occured. Airbrake notified')
                }).error(function() {
                    console.log('Error occured. Could not notify Airbrake.')
                })
                */
                },1000))
                return false
            },2000)
            // If you want to prevent dragging, uncomment this section
            function preventBehavior(e) {
                e.preventDefault(); 
            }
            //document.addEventListener("touchmove", preventBehavior, false);
            /* */

            /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
            see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
            for more details -jm */
            /*
            function handleOpenURL(url)
            {
                    // TODO: do something with the url passed in.
            }
            */

            var _ready = $.Deferred()

            function onBodyLoad() {
                document.addEventListener("deviceready", _ready.resolve, false)
                //console.log('On body load')
                console.log(PhoneGap.DeviceInfo)
                if ('undefined' === typeof(PhoneGap) || !PhoneGap.available) {
                    //console.log('Running outside of mobile device')
                    setTimeout('_ready.resolve()',2000) // delay the resolve so phonegap can call it first if it is loaded
                }
            }

            /* When this function is called, PhoneGap has been initialized and is ready to roll */
            /* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
            see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
            for more details -jm */

            var lastLogin = {}
              , root = this
              , childBrowser = null
              , loaded = $.Deferred()

            _ready.done(function () {
                // do your thing!
                //if (navigator.notification) navigator.notification.alert("PhoneGap is working")

                // First thing to do is to get the user's stored mobile login token, if there is one. otherwise we will ask them ot log in.
                // var db = window.openDatabase("EvilEgo", "1.0", "EvilEgo Local Storage", 200000);

                if (window.localStorage) {
                    var x = window.localStorage.getItem('lastLogin')
                    if (x) {
                        try {
                        lastLogin = JSON.parse(x)
                        } catch (e) {
                            console.log(e)
                            lastLogin = {login:window.localStorage.getItem('lastLogin'),password:''}
                        }
                    } else lastLogin = {login:'',password:''}
                    EvilEgo.currentUser = lastLogin.login
                    if (lastLogin.login != '')
                    EvilEgo.loggedInUser = JSON.parse(window.localStorage.getItem(lastLogin))
                }
                
                if (console.log == logCatcher) console.log=_oldlog
                if (logs && logs.length)
                    _.each(logs,function(t){
                        if (t && t.length && t[0] != null) {
                            console.log.apply(console,t)
                            }
                    })

                loaded.resolve()

                //tx.executeSql("SELECT value FROM settings where name='lastLogin'", [], function(tx, results) {
                    // this will be empty since no rows were inserted.
                    /* This is here to know what to look for later when doing more DB manipulation 
                    console.log("Login ID = " + results.insertId);
                    // this will be 0 since it is a select statement
                    console.log("Rows Affected = " + results.rowAffected);
                    // the number of rows returned by the select statement
                    console.log("Insert ID = " + results.rows.length);
                    /* */
                /*
                        if (results.rows.length>=0) {
                            tx.executeSql("SELECT * FROM user where login=%d", [results[0].value], function(tx, results) {
                            }, function(err) {
                            })
                        }
                }, function (err) {
                        alert("Error processing SQL: "+err.code);
                })
                /* */

            })
        </script>
    </head>
    <body onload="onBodyLoad()" style="-webkit-user-select: none; -webkit-touch-callout: none;"> 
        <!-- LOGIN PAGE -->
        <div data-role="page" id="blank" data-theme="a">
        </div>
        <div data-role="page" id="login" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <div class='logo'>
                    <img src="images/logo_horizontal_sm.png" alt="EvilEgo.com" />
                </div> 
            </div> 
            <div id="loginContainer"></div>
        </div>
        
        <!-- NEWSFEED PAGE -->
        <div data-role="page" id="newsfeed" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <div class="header-button right">
                    <a href="#new-post" data-theme="a" data-role="button" data-icon="plus" data-inline="true" id="new-post-button"></a>
                </div>
                <div class="header-button left">
                    <a href="#newsfeed" data-theme="a" data-role="button" data-icon="refresh" data-inline="true" id="refresh-post-button"></a>
                    <!-- a href="#login" id="logout-button">Logout</a -->
                </div>
                <div class="logo"><img src="images/logo_horizontal_sm.png" alt="EvilEgo.com"></div> 
            </div> 
            <div id="newsfeed-container"></div>
        </div>
        
        <!-- NEW POST PAGE -->
        <div data-role="page" id="new-post" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <div class="header-button right">
                    <a href="#" style="width: 50px;text-decoration: none;"> </a>
                </div>
                <div class="header-button left">
                    <a href="#newsfeed" data-theme="a" data-role="button" data-icon="back" data-inline="true"></a>
                </div>
                <div class='logo'><img src="images/logo_horizontal_sm.png" alt="EvilEgo.com"></div> 
            </div> 
            <div id="new-post-container" data-role='content'></div>
        </div>

        <!-- COMMENTS PAGE -->
        <div data-role="page" id="comments" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <div class="header-button right">
                    <a href="#new-comment" data-theme="a" data-role="button" data-icon="plus" data-inline="true" id="new-comment-button"></a>
                </div>
                <div class="header-button left">
                    <a href="#newsfeed" data-theme="a" data-role="button" data-icon="back" data-inline="true" id="comment-go-back"></a>
                </div>
                <div class='logo'><img src="images/logo_horizontal_sm.png" alt="EvilEgo.com"></div> 
            </div> 
            <div id="comments-container"></div>
        </div>

        <!-- NEW COMMENT PAGE -->
        <div data-role="page" id="new-comment" data-theme="a">
            <div data-role="header" data-position="fixed"> 
                <div class="header-button right">
                    <a href="#" style="width: 50px;text-decoration: none;"> </a>
                </div>
                <div class="header-button left">
                    <a href="#" data-theme="a" data-role="button" data-icon="back" id="cancel-comment"></a>
                </div>
                <div class='logo'><img src="images/logo_horizontal_sm.png" alt="EvilEgo.com"></div> 
            </div> 
            <div id="new-comment-container" data-role='content'></div>
        </div>
        <div data-role="page" id="photo" data-fullscreen="true" class="photoview">
            <div data-role="header" data-position="fixed"> 
                <div class="photocount" style="float:right;margin-top: 20px; margin-right:10px;"></div>
                <div class="header-button left">
                    <a href="#newsfeed" data-theme="a" data-role="button" data-icon="back" data-inline="true"></a>
                </div>
                <div class='logo'><img src="images/logo_horizontal_sm.png" alt="EvilEgo.com"></div> 
            </div>
            <div data-role="content" class="content">
            </div>
            <!-- div data-role="footer" class="ui-bar footer" data-position="fixed"> 
                <a href="#" data-inline="true" data-role="button" data-icon="arrow-l" id='prev-photo'>Prev</a>
                <a href="#" data-inline="true" data-role="button" data-icon="arrow-r" id='next-photo'>Next</a>
                <a href="#" data-inline="true" data-role="button" data-icon="back" id='back-photo'>Back</a>
                </div -->
        </div>
    </body>

    <script type="text/javascript">
        // this sets up the Backbone model to use Mongo's _id
        // put this somewhere in your client Backbone application
        // when it fetches, the MongoDB ID is effectively mapped to the Backbone model correctly
        // https://github.com/documentcloud/backbone/issues/37
        var oldSet = Backbone.Model.prototype.set;
        _.extend(Backbone.Model.prototype, {
            set: function(attrs, options) {
                if ('_id' in attrs) this.id = attrs._id
                oldSet.apply(this, [attrs, options])
                return this
            }
        })
        EvilEgo = {
            currentUser : false
          , models      : {}
          , collections : {}
          , flags       : {}
          , templates   : {}
        }
        function getTemplate(file,addId) {
            console.log('getTemplate: '+file)
            var d = $.Deferred()
            if (EvilEgo.templates[file]) {
                if (addId && $('#'+addId).length==0)
                  $('head').append('<script id="'+addId+'" type="text/x-jquery-tmpl">').append(EvilEgo.templates[file])
                  d.resolveWith(EvilEgo.templates[file])
            }
            if (!addId) 
                addId='script-'+$('script').length
            console.log('getting Template: '+file)
            $.get(file,function(){},'text').done(function(data){
                console.log('Loaded file: '+file)
                EvilEgo.templates[file] = data
                $('head').append('<script id="'+addId+'" type="text/x-jquery-tmpl">')
                $('script#'+addId).html(data)
                d.resolveWith(data)
            }).fail(function(err) {
                console.log('Error occured downloading template file "%s":%s',file)
                console.log(err)
                d.rejectWith(err||'An error occurred while loading template:' +file)
            })
            return d
        }


// Handle iOS not being ready to log console messages.
        logs = []
        function logCatcher(a,b) {
            if (!arguments || !arguments.length) return
            logs.push(arguments)
        }
        _oldlog = console.log
        console.log=logCatcher

    </script>
    
    <script src="js/jquery.tmpl.min.js"></script>
    <script src="model/player.js"></script>
    <script src="view/player.js"></script>
    <script src="model/login.js"></script>
    <script src="view/login.js"></script>
    <script src="model/post.js"></script>
    <script src="view/post.js"></script>
    <script src="model/comments.js"></script>
    <script src="view/comments.js"></script>
    <script src="view/photo.js"></script>
    <script type="text/javascript">
        //Backbone.history.start()
        $.when(loaded).done(function(data) {
            //Backbone.history.start()
            Login = new LoginView ({model: new LoginModel({login:EvilEgo.currentUser||'',password:lastLogin.password})})
            sameOrigin = window.location.origin
            EvilEgo.dataHost = (window['DeviceInfo']&&DeviceInfo.platform)?'http://mobile.evilego.com:4000':sameOrigin
            //console.log('Data Host: '+EvilEgo.dataHost)
            if (EvilEgo.currentUser && EvilEgo.currentUser != '') {
                console.log('Checking session')
                var d = $.ajax({
                    url: EvilEgo.dataHost+'/user/'+EvilEgo.currentUser+'/checkSession'
                  , type: "get"
                })
                var networkTimer = setTimeout(d.fail,10000)
                d.done(function(data) {
                    console.log('Checking session Done')
                    clearTimeout(networkTimer)
                    if (data && data.login == EvilEgo.currentUser) {
                        console.log('Load complete. Display login form')
                        EvilEgo.loggedInUser = data
                        var pc = new PostCollection('newsfeed')
                        var pv = new PostListView(pc)
                        setTimeout(function() {
                            pv.fetch(EvilEgo.currentUser).done(function() {
                                clearTimeout(networkTimer)
                                console.log('Newsfeed Load complete. Display newsfeed')
                                window.location.hash = 'newsfeed'
                                if (navigator && navigator.splashscreen && navigator.splashscreen.hide)
                                    navigator.splashscreen.hide()
                            }).error(function() {
                                clearTimeout(networkTimer)
                                console.log('Newsfeed Load failed. Display login')
                                window.location.hash = 'login'
                                if (navigator && navigator.splashscreen && navigator.splashscreen.hide)
                                    navigator.splashscreen.hide()
                            })
                            var networkTimer = setTimeout(pc.fail,10000)
                        },50)
                    } else {
                        console.log('Load complete. Display login form')
                        window.location.hash = "login"
                        if (window.navigator && navigator.splashscreen && navigator.splashscreen.hide)
                            navigator.splashscreen.hide()
                    }
                }).error(function(error) {
                    clearTimeout(networkTimer)
                    window.location.hash = "login"
                })
            } else {
                window.location.hash = "login"
                if (window.navigator && navigator.splashscreen && navigator.splashscreen.hide)
                    setTimeout(function(){navigator.splashscreen.hide()},500)
            }

        }).fail(function(data) {
            console.log('Error load.')
            console.log(data)
        })
    </script>


</html>
